<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Entra ID — User Browser (Fluent Dark)</title>

    <style>
        :root {
            --bg: #1E1E1E;
            --surface: #252526;
            --panel: #2D2D30;
            --muted-panel: #2B2B2B;
            --text: #FFFFFF;
            --text-secondary: #CFCFCF;
            --divider: #3C3C3C;
            --accent: #0078D4;
            --accent-strong: #0063B1;
            --hover: rgba(255, 255, 255, 0.03);
            --shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
            --success: #107C10;
            --danger: #A4262C;
            --chip-bg: #2F2F30;
            --radius: 10px;
            --ui-font: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: var(--ui-font);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            padding: 20px;
            box-sizing: border-box;
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .col {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn {
            background: var(--accent);
            color: #fff;
            border: 0;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn.ghost {
            background: transparent;
            border: 1px solid var(--divider);
            color: var(--text);
        }

        .btn.icon {
            padding: 8px;
            border-radius: 8px;
            height: 40px;
            width: 40px;
            justify-content: center;
        }

        .muted {
            color: var(--text-secondary);
        }

        .app-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .toolbar {
            display: flex;
            gap: 12px;
            align-items: center;
            background: linear-gradient(180deg, var(--panel), var(--surface));
            padding: 12px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--divider);
        }

        .search-full {
            flex: 1;
            display: flex;
            align-items: center;
            background: var(--muted-panel);
            border-radius: 8px;
            padding: 8px 10px;
            border: 1px solid var(--divider);
            gap: 10px;
        }

        .search-full input {
            flex: 1;
            background: transparent;
            border: 0;
            outline: none;
            color: var(--text);
            font-size: 15px;
            padding: 6px;
        }

        .toolbar-right {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: auto;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            max-width: 1400px;
            margin: 18px auto 0;
        }

        @media(min-width:1200px) {
            .layout {
                grid-template-columns: 1fr 360px;
            }
        }

        .card {
            background: var(--panel);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--divider);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.45);
        }

        .table-wrap {
            overflow: auto;
            border-radius: 10px;
            border: 1px solid var(--divider);
            background: linear-gradient(180deg, var(--surface), var(--panel));
        }

        table.user-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            color: var(--text);
        }

        table.user-table thead th {
            position: sticky;
            top: 0;
            background: linear-gradient(180deg, var(--panel), #272727);
            z-index: 10;
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--divider);
            font-weight: 600;
        }

        table.user-table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            transition: background .12s ease;
            cursor: pointer;
        }

        table.user-table tbody tr:hover {
            background: var(--hover);
        }

        table.user-table td {
            padding: 10px;
            vertical-align: middle;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #fff;
        }

        .cell-muted {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .badge {
            display: inline-flex;
            padding: 6px 8px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 12px;
            align-items: center;
            gap: 8px;
        }

        .badge.active {
            background: rgba(16, 124, 16, 0.15);
            color: var(--success);
            border: 1px solid rgba(16, 124, 16, 0.22);
        }

        .badge.disabled {
            background: rgba(164, 38, 44, 0.08);
            color: var(--danger);
            border: 1px solid rgba(164, 38, 44, 0.16);
        }

        .chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 8px;
            margin: 6px 0 0;
        }

        .chip {
            background: var(--chip-bg);
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--divider);
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* DRAWERS: use translateX to hide fully */
        .drawer {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 420px;
            max-width: calc(100% - 40px);
            background: linear-gradient(180deg, var(--panel), var(--surface));
            box-shadow: -20px 0 40px rgba(0, 0, 0, 0.7);
            transition: transform .22s ease;
            border-left: 1px solid var(--divider);
            padding: 18px;
            z-index: 1200;
            overflow: auto;
            transform: translateX(100%);
        }

        .drawer.open {
            transform: translateX(0);
        }

        .drawer h3 {
            margin: 0 0 12px;
            color: var(--text);
            font-size: 18px;
        }

        .detail-drawer {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 720px;
            max-width: calc(100% - 40px);
            background: linear-gradient(180deg, var(--panel), #262626);
            box-shadow: -20px 0 60px rgba(0, 0, 0, 0.7);
            transition: transform .25s ease;
            border-left: 1px solid var(--divider);
            padding: 20px;
            z-index: 1300;
            overflow: auto;
            transform: translateX(100%);
        }

        .detail-drawer.open {
            transform: translateX(0);
        }

        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }

        .field-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.02);
            margin-bottom: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
        }

        @media(min-width:900px) {
            .detail-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .detail-card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .detail-row .k {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .detail-row .v {
            color: var(--text);
        }

        .muted-btn {
            background: transparent;
            border: 1px solid var(--divider);
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .small {
            font-size: 13px;
        }

        .sep {
            height: 1px;
            background: var(--divider);
            margin: 12px 0;
            border-radius: 2px;
        }

        .fade-in {
            animation: fadeUp .18s ease both;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(6px)
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        label {
            display: block;
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 6px;
        }

        select,
        input {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--divider);
            background: var(--muted-panel);
            color: var(--text);
            width: 100%;
            box-sizing: border-box;
        }

        .cond-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .cond-row>* {
            flex: 1;
        }

        .cond-row .op {
            max-width: 150px;
        }
    </style>

    <!-- SVG helper -->
    <script>
        function svg(name) {
            const icons = {
                search: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M11 4a7 7 0 1 0 0 14 7 7 0 0 0 0-14zm8.707 15.293-3.853-3.853" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                filter: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M22 6H2l7 8v6l6-4v-2l7-8z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                columns: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="6" height="18" rx="1" stroke="currentColor" stroke-width="1.4"/><rect x="15" y="3" width="6" height="10" rx="1" stroke="currentColor" stroke-width="1.4"/></svg>',
                close: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                user: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>'
            };
            return icons[name] || '';
        }
    </script>
</head>

<body>
    <div class="app-header fade-in">
        <div class="toolbar">
            <div class="search-full">
                <span style="color:var(--text-secondary);display:flex;align-items:center;">
                    <span id="iconSearch" style="display:flex;align-items:center;"></span>
                </span>
                <input id="searchInput" type="text" placeholder="Search users, attributes, email, phone, groups…" />
            </div>

            <div class="toolbar-right">
                <button id="openFilter" class="btn ghost" title="Filter"><span id="iconFilter"></span> Filter</button>
                <button id="openColumns" class="btn ghost" title="Columns"><span id="iconColumns"></span>
                    Columns</button>
                <button id="resetAll" class="btn ghost" title="Reset">Reset</button>
            </div>
        </div>

        <div id="activeFilters" class="chips"></div>
    </div>

    <div class="layout">
        <div class="card fade-in">
            <div class="table-wrap" id="tableContainer">
                <table class="user-table">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- FILTER DRAWER -->
    <div id="filterDrawer" class="drawer" aria-hidden="true">
        <div class="row" style="justify-content:space-between;margin-bottom:10px;">
            <h3>Filters</h3>
            <button class="btn icon ghost btn-close-drawer" onclick="closeFilterDrawer()"><span
                    class="icon-close"></span></button>
        </div>

        <div class="col" style="margin-bottom:12px;">
            <label for="filterFieldSelector">Add filter for field:</label>
            <select id="filterFieldSelector"></select>
        </div>

        <div id="conditionEditor">
            <div class="cond-row">
                <select id="filterOperator" class="op">
                    <option value="contains">contains</option>
                    <option value="equals">equals</option>
                    <option value="starts">starts with</option>
                    <option value="ends">ends with</option>
                    <option value="empty">is empty</option>
                    <option value="notempty">is not empty</option>
                </select>
                <input id="filterValue" type="text" placeholder="Value (leave empty for empty/notempty)" />
            </div>
            <div style="display:flex;gap:8px;">
                <button class="btn" onclick="addFilterCondition()">Add Condition</button>
                <button class="btn ghost" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
        <div class="sep" style="margin-top:12px;"></div>
    </div>

    <!-- COLUMNS DRAWER -->
    <div id="columnDrawer" class="drawer" aria-hidden="true">
        <div class="row" style="justify-content:space-between;margin-bottom:10px;">
            <h3>Visible Columns</h3>
            <button class="btn icon ghost btn-close-drawer" onclick="closeColumnDrawer()"><span
                    class="icon-close"></span></button>
        </div>

        <div id="columnList"></div>

        <div class="sep"></div>
        <button class="btn" onclick="saveColumnSelection()">Apply</button>
    </div>

    <!-- DETAIL DRAWER -->
    <div id="detailDrawer" class="detail-drawer" aria-hidden="true">
        <div class="detail-header">
            <h2 id="detailTitle" style="display:flex;align-items:center;gap:10px;">
                <span id="detailUserIcon"></span> User Details
            </h2>
            <button class="btn icon ghost btn-close-drawer" onclick="closeDetailDrawer()"><span
                    class="icon-close"></span></button>
        </div>

        <div id="detailContent"></div>
    </div>

    <!-- OUTSIDE CLICK HANDLER, ESC -->
    <script>
        window.addEventListener("click", (event) => {
            const filter = document.getElementById("filterDrawer");
            const col = document.getElementById("columnDrawer");
            const detail = document.getElementById("detailDrawer");

            if (filter?.classList.contains("open") && !filter.contains(event.target) && event.target !== document.getElementById("openFilter")) closeFilterDrawer();
            if (col?.classList.contains("open") && !col.contains(event.target) && event.target !== document.getElementById("openColumns")) closeColumnDrawer();
            if (detail?.classList.contains("open") && !detail.contains(event.target)) closeDetailDrawer();
        });

        window.addEventListener("keydown", (e) => {
            if (e.key === "Escape") { closeFilterDrawer(); closeColumnDrawer(); closeDetailDrawer(); }
        });
    </script>

    <!-- MSAL -->
    <script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>

    <script>
        /* ===========================
           CONFIG / FIELDS / STATE
        ============================*/
        const tenantId = '1b2bcaa0-2052-4943-bd9b-2511e7d57a21';
        const clientId = 'c34ceb14-3218-4ec5-8bd4-39a66ede3603';
        const redirectUri = "https://flogerber.github.io/EntraIdUserMangement/";

        const msalConfig = {
            auth: { clientId, authority: `https://login.microsoftonline.com/${tenantId}`, redirectUri },
            cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false }
        };

        const scopes = ["User.Read.All", "Directory.Read.All"];

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        const BASE_FIELDS = ["displayName", "userPrincipalName", "mail", "mobile", "accountEnabled"];
        const EXTRA_FIELDS = ["jobTitle", "department", "companyName", "usageLocation", "employeeId", "employeeType", "country", "officeLocation", "streetAddress", "id"];
        const ALL_FIELDS = [...BASE_FIELDS, ...EXTRA_FIELDS];

        const FRIENDLY = {
            displayName: "Display Name", userPrincipalName: "User Principal Name", mail: "Email", mobile: "Mobile",
            jobTitle: "Job Title", department: "Department", companyName: "Company", accountEnabled: "Enabled",
            usageLocation: "Usage Location", employeeId: "Employee ID", employeeType: "Employee Type",
            country: "Country", officeLocation: "Office", streetAddress: "Address", id: "Object ID"
        };

        let allUsers = [];
        let visibleColumns = [...BASE_FIELDS];
        let activeFilters = [];
        let sortField = null;
        let sortDir = 1;

        /* ===========================
           ICON POPULATION
        ============================*/
        function populateStaticIcons() {
            const set = (id, name) => { const el = document.getElementById(id); if (el) el.innerHTML = svg(name); };
            set("iconSearch", "search"); set("iconFilter", "filter"); set("iconColumns", "columns"); set("detailUserIcon", "user");
            document.querySelectorAll(".icon-close").forEach(s => s.innerHTML = svg("close"));
        }

        /* ===========================
           AUTH / BOOTSTRAP
        ============================*/
        // ensure redirect responses are processed before app logic
        async function initializeAuth() {
            try {
                const redirectResult = await msalInstance.handleRedirectPromise();
                if (redirectResult && redirectResult.account) {
                    msalInstance.setActiveAccount(redirectResult.account);
                } else {
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length === 1) msalInstance.setActiveAccount(accounts[0]);
                    // if multiple, you might prompt account selection - we take first
                    else if (accounts.length > 1) msalInstance.setActiveAccount(accounts[0]);
                }
                // if no active account, redirect to login so we have a session
                if (!msalInstance.getActiveAccount()) {
                    // prefer redirect login to avoid popup blockers in embedded contexts
                    await msalInstance.loginRedirect({ scopes });
                    return false; // redirect will navigate away
                }
                return true;
            } catch (err) {
                console.error("initializeAuth error", err);
                // try interactive fallback
                try { await msalInstance.loginRedirect({ scopes }); return false; } catch (e) { console.error("loginRedirect failed", e); return false; }
            }
        }

        async function getToken() {
            const account = msalInstance.getActiveAccount();
            if (!account) {
                // if no account, request redirect login
                await msalInstance.loginRedirect({ scopes });
                return null;
            }

            try {
                const silent = await msalInstance.acquireTokenSilent({ scopes, account });
                return silent.accessToken;
            } catch (err) {
                console.warn("acquireTokenSilent failed, trying interactive fallback", err);
                // if interaction required, use redirect fallback (safer than popup in many environments)
                try {
                    const popup = await msalInstance.acquireTokenPopup({ scopes, account });
                    return popup.accessToken;
                } catch (popupErr) {
                    console.warn("acquireTokenPopup failed, falling back to redirect", popupErr);
                    try {
                        await msalInstance.acquireTokenRedirect({ scopes, account });
                        return null;
                    } catch (redErr) {
                        console.error("acquireTokenRedirect failed", redErr);
                        return null;
                    }
                }
            }
        }

        /* ===========================
           GRAPH HELPERS
        ============================*/
        async function fetchAllPages(url, token) {
            let items = [];
            while (url) {
                const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(`Graph fetch failed: ${res.status} ${txt}`);
                }
                const data = await res.json();
                items.push(...(data.value || []));
                url = data["@odata.nextLink"];
            }
            return items;
        }

        async function loadUsers() {
            const token = await getToken();
            if (!token) return; // redirect in progress

            const url = `https://graph.microsoft.com/v1.0/users?$select=${ALL_FIELDS.join(",")}`;
            try {
                allUsers = await fetchAllPages(url, token);
            } catch (err) {
                console.error("Failed to load users", err);
                allUsers = [];
            }

            renderTable(allUsers);
            populateFilterFields();
            populateColumnDrawer();
        }

        /* ===========================
           RENDER / TABLE
        ============================*/
        function renderTable(data) {
            const head = document.getElementById("tableHead"), body = document.getElementById("tableBody");
            if (!head || !body) return;
            head.innerHTML = `<tr>${visibleColumns.map(c => `<th onclick="sortBy('${c}')">${escapeHtml(FRIENDLY[c] ?? c)} ${sortField === c ? (sortDir === 1 ? "▲" : "▼") : ""}</th>`).join("")}</tr>`;
            body.innerHTML = (data || []).map(u => `<tr onclick="openUserDetails('${escapeHtml(u.id || "")}')">${visibleColumns.map(f => formatCell(f, u)).join("")}</tr>`).join("");
        }

        function formatCell(field, user) {
            let val = user?.[field] ?? "";
            if (field === "accountEnabled") {
                return `<td><span class="badge ${val ? "active" : "disabled"}">${val ? "Active" : "Disabled"}</span></td>`;
            }
            return `<td>${escapeHtml(String(val))}</td>`;
        }

        function escapeHtml(str) {
            return (str || "").replace(/[&<>"'`=\/]/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '`': '&#96;', '=': '&#61;', '/': '&#47;' })[s]);
        }

        /* ===========================
           SORT
        ============================*/
        function sortBy(field) {
            if (sortField === field) sortDir *= -1; else { sortField = field; sortDir = 1; }
            const sorted = [...(allUsers || [])].sort((a, b) => {
                const x = ((a[field] ?? "") + "").toLowerCase();
                const y = ((b[field] ?? "") + "").toLowerCase();
                if (x > y) return sortDir; if (x < y) return -sortDir; return 0;
            });
            renderTable(sorted);
        }

        /* ===========================
           SEARCH + FILTERS
        ============================*/
        function applySearchAndFilters() {
            const search = (document.getElementById("searchInput")?.value || "").toLowerCase();
            const data = (allUsers || []).filter(u => {
                const text = Object.values(u || {}).join(" ").toLowerCase();
                if (!text.includes(search)) return false;
                return activeFilters.every(f => applyFilter(u, f));
            });
            renderTable(data);
        }

        function applyFilter(user, f) {
            const val = ((user?.[f.field] ?? "") + "").toLowerCase();
            const needle = (f.value || "").toLowerCase();
            switch (f.op) {
                case "contains": return val.includes(needle);
                case "equals": return val === needle;
                case "starts": return val.startsWith(needle);
                case "ends": return val.endsWith(needle);
                case "empty": return val === "";
                case "notempty": return val !== "";
                default: return true;
            }
        }

        /* ===========================
           FILTER DRAWER LOGIC (add/edit/remove)
        ============================*/
        function populateFilterFields() {
            const sel = document.getElementById("filterFieldSelector");
            if (!sel) return;
            sel.innerHTML = ALL_FIELDS.map(f => `<option value="${f}">${escapeHtml(FRIENDLY[f] ?? f)}</option>`).join("");
        }

        function addFilterCondition() {
            const field = document.getElementById("filterFieldSelector")?.value;
            const op = document.getElementById("filterOperator")?.value;
            const value = (document.getElementById("filterValue")?.value || "").trim();

            if (!field) return;
            // allow empty for empty/notempty
            if (op !== "empty" && op !== "notempty" && value === "") {
                // don't add empty value filters except empty/notempty
                alert("Please provide a value for this filter (or choose 'is empty'/'is not empty').");
                return;
            }

            activeFilters.push({ field, op, value });
            redrawActiveFilters();
            applySearchAndFilters();
        }

        function redrawActiveFilters() {
            const wrap = document.getElementById("activeFilters");
            if (!wrap) return;
            wrap.innerHTML = activeFilters.map((f, idx) => `
        <div class="chip" id="chip-${idx}">
          <span style="font-weight:600">${escapeHtml(FRIENDLY[f.field] ?? f.field)}</span>
          <span>:</span>
          <span>${escapeHtml(f.op)}</span>
          <span>"${escapeHtml(f.value || "")}"</span>
          <button class="muted-btn" onclick="editFilter(${idx})">Edit</button>
          <button class="muted-btn" onclick="removeFilter(${idx})">Remove</button>
        </div>
      `).join("");
        }

        function removeFilter(i) {
            if (i < 0 || i >= activeFilters.length) return;
            activeFilters.splice(i, 1);
            redrawActiveFilters();
            applySearchAndFilters();
        }

        // when editing, replace chip with inline editor
        function editFilter(idx) {
            const f = activeFilters[idx];
            if (!f) return;
            const container = document.getElementById(`chip-${idx}`);
            if (!container) return;
            container.innerHTML = `
        <div style="display:flex;gap:8px;align-items:center;">
          <select id="editField-${idx}" style="min-width:160px;">
            ${ALL_FIELDS.map(ff => `<option value="${ff}" ${ff === f.field ? 'selected' : ''}>${escapeHtml(FRIENDLY[ff] ?? ff)}</option>`).join("")}
          </select>
          <select id="editOp-${idx}" style="min-width:140px;">
            <option value="contains" ${f.op === 'contains' ? 'selected' : ''}>contains</option>
            <option value="equals" ${f.op === 'equals' ? 'selected' : ''}>equals</option>
            <option value="starts" ${f.op === 'starts' ? 'selected' : ''}>starts with</option>
            <option value="ends" ${f.op === 'ends' ? 'selected' : ''}>ends with</option>
            <option value="empty" ${f.op === 'empty' ? 'selected' : ''}>is empty</option>
            <option value="notempty" ${f.op === 'notempty' ? 'selected' : ''}>is not empty</option>
          </select>
          <input id="editVal-${idx}" value="${escapeHtml(f.value || '')}" placeholder="value"/>
          <button class="btn" onclick="saveEditedFilter(${idx})">Save</button>
          <button class="btn ghost" onclick="cancelEdit(${idx})">Cancel</button>
        </div>
      `;
        }

        function saveEditedFilter(idx) {
            const field = document.getElementById(`editField-${idx}`)?.value;
            const op = document.getElementById(`editOp-${idx}`)?.value;
            const value = (document.getElementById(`editVal-${idx}`)?.value || "").trim();
            if (!field) return;
            if (op !== "empty" && op !== "notempty" && value === "") {
                alert("Please provide a value for this filter (or choose empty/notempty).");
                return;
            }
            activeFilters[idx] = { field, op, value };
            redrawActiveFilters();
            applySearchAndFilters();
        }

        function cancelEdit(idx) {
            redrawActiveFilters();
        }

        function applyFilters() {
            applySearchAndFilters();
            closeFilterDrawer();
        }

        /* ===========================
           COLUMN DRAWER
        ============================*/
        function populateColumnDrawer() {
            const wrap = document.getElementById("columnList");
            if (!wrap) return;
            wrap.innerHTML = ALL_FIELDS.map(f => `
        <label style="display:block;padding:6px 0;">
          <input type="checkbox" ${visibleColumns.includes(f) ? "checked" : ""} onchange="toggleColumn('${f}', this.checked)" />
          ${escapeHtml(FRIENDLY[f] ?? f)}
        </label>
      `).join("");
        }

        function toggleColumn(field, show) {
            if (show) { if (!visibleColumns.includes(field)) visibleColumns.push(field); }
            else visibleColumns = visibleColumns.filter(f => f !== field);
        }

        function saveColumnSelection() { closeColumnDrawer(); renderTable(allUsers); }

        /* ===========================
           DETAIL DRAWER
        ============================*/
        async function openUserDetails(id) {
            if (!id) return;
            const token = await getToken();
            if (!token) return;
            try {
                const res = await fetch(`https://graph.microsoft.com/v1.0/users/${encodeURIComponent(id)}?$select=${ALL_FIELDS.join(",")}`, { headers: { Authorization: `Bearer ${token}` } });
                if (!res.ok) { console.error("Failed to fetch user", res.status); return; }
                const user = await res.json();
                renderUserDetails(user);
                document.getElementById("detailDrawer")?.classList.add("open");
            } catch (e) { console.error("openUserDetails error", e); }
        }

        function renderUserDetails(u) {
            const wrap = document.getElementById("detailContent");
            if (!wrap) return;
            wrap.innerHTML = ALL_FIELDS.map(f => `
        <div class="detail-row">
          <div class="label">${escapeHtml(FRIENDLY[f] ?? f)}</div>
          <div class="value">${escapeHtml((u?.[f] ?? "") + "")}</div>
        </div>
      `).join("");
        }

        function closeDetailDrawer() { document.getElementById("detailDrawer")?.classList.remove("open"); }

        /* ===========================
           DRAWER OPEN/CLOSE
        ============================*/
        function openFilterDrawer() { document.getElementById("filterDrawer")?.classList.add("open"); }
        function closeFilterDrawer() { document.getElementById("filterDrawer")?.classList.remove("open"); }
        function openColumnDrawer() { document.getElementById("columnDrawer")?.classList.add("open"); populateColumnDrawer(); }
        function closeColumnDrawer() { document.getElementById("columnDrawer")?.classList.remove("open"); }

        /* ===========================
           EVENT BINDINGS + INIT
        ============================*/
        document.getElementById("searchInput")?.addEventListener("input", applySearchAndFilters);
        document.getElementById("openFilter").onclick = openFilterDrawer;
        document.getElementById("openColumns").onclick = openColumnDrawer;
        document.getElementById("resetAll").onclick = () => {
            const si = document.getElementById("searchInput");
            if (si) si.value = "";
            activeFilters = [];
            redrawActiveFilters();
            renderTable(allUsers);
        };

        // init on DOM ready
        document.addEventListener("DOMContentLoaded", async () => {
            populateStaticIcons();
            populateFilterFields();
            // initialize auth, then load data
            const ok = await initializeAuth();
            if (ok) {
                // do not await here if you want faster UI, but we await to ensure token available
                await loadUsers();
            }
        });
    </script>
</body>

</html>